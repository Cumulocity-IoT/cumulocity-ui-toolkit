<div class="menu" data-cy="kpi-menu">
  <span class="text-muted">{{ timestampEnd | c8yDate }}</span>

  @if (paging && config().showMeta) {
    <span>
      {{ results }} Results
      @if (paging.totalPages <= pageLimit) {
        <span
          class="text-muted"
          [tooltip]="'Current Page: ' + paging.currentPage + '\nTotal Pages: ' + paging.totalPages"
          [placement]="'bottom'"
        >
          ({{ paging.currentPage }}/{{ paging.totalPages }})
        </span>
      } @else {
        <span
          class="text-muted"
          [tooltip]="
            'Current Page: ' +
            paging.currentPage +
            '\nPage Limit: ' +
            pageLimit +
            '\nTotal Pages: ' +
            paging.totalPages
          "
          [placement]="'bottom'"
        >
          ({{ paging.currentPage }}/{{ pageLimit }}|{{ paging.totalPages }})
        </span>
      }
    </span>
  }

  @if (!loading() && !assetGroups) {
    <span class="text-muted">-</span>
  }

  <div class="dropdown" dropdown>
    <button
      class="dropdown-toggle c8y-dropdown"
      dropdownToggle
      type="button"
      title="dropdown-toggle"
    >
      <i [c8yIcon]="'ellipsis-v'"></i>
    </button>

    <ul class="dropdown-menu dropdown-menu-right" *dropdownMenu>
      <li>
        <button
          [disabled]="!paging || paging?.totalPages <= paging?.currentPage"
          (click)="loadNextBatch()"
          type="button"
        >
          <i [c8yIcon]="'chevron-double-right'"></i>
          {{ 'Load next batch' | translate }}
        </button>
      </li>
      <li>
        <button (click)="loadData()" type="button">
          <i [c8yIcon]="'refresh'"></i>
          {{ 'Refresh' | translate }}
        </button>
      </li>
    </ul>
  </div>
</div>

<!-- manual load trigger -->
@if (!config().runOnLoad && !timestampStart) {
  <div class="d-flex j-c-center p-16">
    <button class="btn btn-primary" (click)="loadData()" type="button">
      {{ 'Load data' | translate }}
    </button>
  </div>
}

<!-- views -->
@if (loading()) {
  <div class="loading-data">
    <c8y-loading></c8y-loading>
  </div>
} @else {
  @if (assetGroups?.length) {
    @switch (config().display) {
      @case (displayMode.list) {
        <ng-template
          [ngTemplateOutlet]="assetListTemplateDefault"
          [ngTemplateOutletContext]="{ assets: assetGroups[0].objects }"
        >
        </ng-template>
      }
      @case (displayMode.pieAggregate) {
        <ng-template
          [ngTemplateOutlet]="pieCHartTemplateDefault"
          [ngTemplateOutletContext]="{ assets: assetGroups }"
        >
        </ng-template>
      }
      @case (displayMode.pieCount) {
        <ng-template
          [ngTemplateOutlet]="pieCHartTemplateDefault"
          [ngTemplateOutletContext]="{ assets: assetGroups }"
        >
        </ng-template>
      }
      @default {
        <ng-template
          [ngTemplateOutlet]="barChartTemplateDefault"
          [ngTemplateOutletContext]="{ groups: assetGroups }"
        >
        </ng-template>
      }
    }
  } @else {
    <div class="p-16">
      <h2 class="m-b-16">Empty AssetGroup Result</h2>
      <pre>{{ config | json }}</pre>
    </div>
  }

  @if (config().showMeta && timestampEnd) {
    <div class="d-flex j-c-center m-t-16 p-b-8">
      <small class="text-muted">{{ 'Query duration' }}: {{ duration }}</small>
    </div>
  }
}

<!-- bar chart basic -->
<ng-template #barChartTemplateDefault let-groups="assetGroups">
  @if (assetGroups) {
    <ul class="bar-chart">
      @for (group of assetGroups; track group) {
        <li>
          <ng-template
            [ngTemplateOutlet]="barChartItemTemplateDefault"
            [ngTemplateOutletContext]="{ group: group }"
          >
          </ng-template>
        </li>
      }
    </ul>
  }
</ng-template>

<!-- bar chat item -->
<ng-template #barChartItemTemplateDefault let-group="group">
  <label class="text-truncate">{{ group.label }}</label>
  <span>
    {{ group.value }}
    @if (config().percent) {
      <span class="percent text-muted"> {{ (group.value / total) * 100 | number: '1.1-1' }}% </span>
    }
  </span>
  <div
    [ngStyle]="{
      width: (group.value / max) * 100 + '%',
      backgroundColor: config().color,
      opacity: config().opacity / 100,
    }"
  ></div>
</ng-template>

<!-- table -->
<ng-template #assetListTemplateDefault let-assets="assets">
  <table class="table table-striped">
    <thead>
      <tr>
        <th translate>Asset</th>
        <th translate>System ID</th>
        <th translate>Type</th>
        <th translate>Model</th>
        <th translate>Registration Date</th>
        <th translate>Last Updated</th>
      </tr>
    </thead>
    <tbody>
      @for (asset of assets; track asset) {
        <tr>
          <td>
            @if (asset.c8y_IsDeviceGroup) {
              <a [routerLink]="['/group', asset.id]">{{ asset.name }}</a>
            } @else {
              <a [routerLink]="['/device', asset.id]">{{ asset.name }}</a>
            }
          </td>
          <td class="text-right">{{ asset.id }}</td>
          <td>{{ asset.type || '-' }}</td>
          <td>{{ asset.c8y_Hardware?.model || '-' }}</td>
          <td>{{ asset.creationTime | c8yDate }}</td>
          <td>{{ asset.lastUpdated | c8yDate }}</td>
        </tr>
      }
    </tbody>
  </table>
</ng-template>

<!-- pie chart -->
<ng-template #pieCHartTemplateDefault let-assets="assets">
  <div class="chart-wrap">
    <canvas [data]="pieChartData" [type]="'pie'" [options]="pieChartOptions" baseChart> </canvas>
  </div>
</ng-template>
