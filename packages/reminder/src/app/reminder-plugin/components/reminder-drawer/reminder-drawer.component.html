<aside [class.open]="open">
  <header>
    <h2 translate>Reminder</h2>
    <small title="{{ lastUpdate | c8yDate }}">
      {{ 'Last updated' | translate }}: {{ lastUpdate | amTimeAgo }}
    </small>
  </header>

  <ul class="drawer-actions">
    <li>
      <button class="btn btn-primary" (click)="createReminder()" type="button">
        <i [c8yIcon]="'plus-circle'"></i>
        {{ 'Create Reminder' | translate }}
      </button>
    </li>
  </ul>

  <div class="body">
    <!-- filter: reminder type -->
    @if (types.length) {
      <div class="filter">
        <label for="reminder-type-filter" translate>Filter by Reminder Type</label>
        <div class="c8y-select-wrapper">
          <select
            class="form-control"
            id="reminder-type-filter"
            [(ngModel)]="reminderTypeFilter"
            (change)="setFilter()"
            name="reminder-type"
          >
            <option value="">{{ 'Not filtered' | translate }}</option>
            @for (type of types; track type) {
              <option [ngValue]="type.id">{{ type.name }}</option>
            }
          </select>
        </div>
      </div>
    }

    <!-- context filter -->
    <div class="filter">
      <label class="c8y-switch">
        <input [(ngModel)]="contextFilterEnabled" type="checkbox" name="context-filter-enabled" />
        <span></span>
        {{ 'Filter by Current Context' | translate }}
      </label>
    </div>

    <!-- list of reminders -->
    <ul class="reminder-group-list">
      @for (group of reminderGroups; track group) {
        <li class="reminder-group-item">
          <header>
            <button
              class="btn btn-clean"
              [attr.aria-expanded]="groupIsExpanded[$index]"
              (click)="groupIsExpanded[$index] = !groupIsExpanded[$index]"
              type="button"
              aria-controls="collapseBasic"
            >
              <span
                class="count"
                [class.text-danger]="group.status === reminderGroupStatus.due && group.count > 0"
              >
                {{ group.count || 0 }}
                @if (group.total) {
                  <small title="{{ 'Number of reminders if not filtered' | translate }}">
                    / {{ group.total }}
                  </small>
                }
              </span>
              <em>{{ group.status | translate }}</em>
              <i [c8yIcon]="'expand-arrow'" [class.expanded]="groupIsExpanded[$index]"></i>
            </button>
          </header>

          <ul
            class="reminder-list"
            id="collapseBasic"
            [collapse]="!groupIsExpanded[$index]"
            [isAnimated]="true"
          >
            <!-- TODO add empty info -->
            @for (reminder of group.reminders; track reminder) {
              <ng-template
                [ngTemplateOutlet]="reminderItem"
                [ngTemplateOutletContext]="{ reminder }"
              >
              </ng-template>
            }
          </ul>
        </li>
      }
    </ul>

    <small translate>
      Cleared reminders are automatically deleted over time by the retention rules.
    </small>
  </div>

  <footer>
    <div>
      <label class="c8y-switch">
        <input
          [(ngModel)]="toastNotificationsEnabled"
          (change)="setConfig('toast')"
          type="checkbox"
          name="toast-notifications-enabled"
        />
        <span></span>
        {{ 'Toast Notifications' | translate }}
      </label>
    </div>

    <div>
      <label class="c8y-switch">
        <input
          [(ngModel)]="browserNotificationsEnabled"
          (change)="setConfig('browser')"
          type="checkbox"
          name="browser-notifications-enabled"
        />
        <span></span>
        {{ 'Browser Notifications' | translate }}
      </label>
    </div>
  </footer>
</aside>

<!-- single reminder item template -->
<ng-template #reminderItem let-reminder="reminder">
  <li
    class="reminder-item"
    [ngClass]="{
      active: reminder.status !== reminderStatus.active,
      changed: reminder.changed,
    }"
  >
    <header>
      <i
        class="status-icon"
        [c8yIcon]="
          reminder.status === reminderStatus.active
            ? 'bell'
            : reminder.status === reminderStatus.acknowledged
              ? 'bell-slash'
              : 'check-circle'
        "
        title="Status: {{ reminder.status }}"
      ></i>

      @if (reminder.status !== reminderStatus.cleared) {
        <small
          class="date"
          [class.text-danger]="reminder.status === reminderStatus.active && reminder.diff > 0"
          title="{{ 'Due' | translate }}: {{ reminder.time | c8yDate }}"
        >
          {{ reminder.time | amTimeAgo }}
        </small>
      } @else {
        <small class="date">
          <span title="{{ 'Due' | translate }}: {{ reminder.lastUpdated | c8yDate }}">
            {{ reminder.time | amTimeAgo }}
          </span>
          <span title="{{ 'Last Updated' | translate }}: {{ reminder.lastUpdated | c8yDate }}">
            {{ reminder.lastUpdated | amTimeAgo }}
          </span>
        </small>
      }

      <ul class="actions">
        @if (reminder.status === reminderStatus.active) {
          <button
            class="btn btn-xs btn-hollow btn-success"
            (click)="updateReminder(reminder, reminderStatus.acknowledged)"
            type="button"
            title="{{ 'Acknowledge the reminder' | translate }}"
          >
            <i [c8yIcon]="'bell-slash'"></i>
          </button>
        }
        @if (reminder.status !== reminderStatus.cleared) {
          <button
            class="btn btn-xs btn-hollow btn-danger"
            (click)="updateReminder(reminder, reminderStatus.cleared)"
            type="button"
            title="{{ 'Clear the reminder' | translate }}"
          >
            <i [c8yIcon]="'check-circle'"></i>
          </button>
        }
        @if (reminder.status === reminderStatus.cleared) {
          <button
            class="btn btn-xs btn-hollow btn-primary"
            (click)="updateReminder(reminder, reminderStatus.active)"
            type="button"
            title="{{ 'Reactivate the reminder' | translate }}"
          >
            <i [c8yIcon]="'bell'"></i>
          </button>
        }
      </ul>
    </header>

    <p>
      {{ reminder.text }}
    </p>

    <footer>
      <!-- type -->
      @if (types.length && reminder.reminderType) {
        <button
          class="btn btn-clean reminder-tag"
          (click)="setFilter(reminder.reminderType)"
          type="button"
          title="{{ 'Filter by this Reminder Type' | translate }}"
        >
          <i class="m-r-4" [c8yIcon]="'tag'"></i>
          <c8y-reminder-type [id]="reminder.reminderType"></c8y-reminder-type>
        </button>
      }
      <!-- asset reference -->
      @if (reminder.isGroup) {
        <a [routerLink]="['/group', reminder.source.id]">
          <i [c8yIcon]="'c8y-group-open'"></i>
          {{ reminder.source.name }}
        </a>
      } @else {
        <a [routerLink]="['/device', reminder.source.id]">
          <!-- arrows-dotted-left-right -->
          <i [c8yIcon]="'c8y-device'"></i>
          {{ reminder.source.name }}
        </a>
      }
    </footer>
  </li>
</ng-template>
