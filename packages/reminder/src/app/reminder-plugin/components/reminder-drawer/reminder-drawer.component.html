<aside [class.open]="open">
  <header>
    <h2 translate>Reminder</h2>
    <small class="text-muted" title="{{ lastUpdate | c8yDate }}">
      {{ 'Last updated' | translate }}: {{ lastUpdate | amTimeAgo }}
    </small>
  </header>

  <ul class="drawer-actions">
    <li>
      <button class="btn btn-primary" (click)="createReminder()" type="button">
        <i [c8yIcon]="'plus-circle'"></i>
        {{ 'Create Reminder' | translate }}
      </button>
    </li>
  </ul>

  <div class="body">
    <!-- filter: reminder type -->
    @if (types.length) {
      <div class="filter">
        <label for="reminder-type-filter" translate>Filter by Reminder Type</label>
        <div class="c8y-select-wrapper">
          <select
            class="form-control"
            id="reminder-type-filter"
            [(ngModel)]="reminderTypeFilter"
            (change)="setFilter()"
            name="reminder-type"
          >
            <option value="">{{ 'Not filtered' | translate }}</option>
            <option *ngFor="let type of types" [ngValue]="type.id">{{ type.name }}</option>
          </select>
        </div>
      </div>
    }

    <!-- context filter -->
    <div class="filter">
      <label class="c8y-switch">
        <input [(ngModel)]="contextFilterEnabled" type="checkbox" name="context-filter-enabled" />
        <span></span>
        {{ 'Filter by Current Context' | translate }}
      </label>
    </div>

    <!-- list of reminders -->
    <ul class="reminder-group-list">
      <li class="reminder-group-item" *ngFor="let group of reminderGroups; let i = index">
        <header>
          <button
            class="btn btn-clean"
            [attr.aria-expanded]="groupIsExpanded[i]"
            (click)="groupIsExpanded[i] = !groupIsExpanded[i]"
            type="button"
            aria-controls="collapseBasic"
          >
            <span
              class="count"
              [class.text-danger]="group.status === reminderGroupStatus.due && group.count > 0"
            >
              {{ group.count || 0 }}
              <small
                class="text-muted"
                *ngIf="group.total"
                title="{{ 'Number of reminders if not filtered' | translate }}"
              >
                / {{ group.total }}
              </small>
            </span>
            <em>{{ group.status | translate }}</em>
            <i [c8yIcon]="'expand-arrow'" [class.expanded]="groupIsExpanded[i]"></i>
          </button>
        </header>

        <ul
          class="reminder-list"
          id="collapseBasic"
          [collapse]="!groupIsExpanded[i]"
          [isAnimated]="true"
        >
          <!-- TODO add empty info -->
          <ng-container *ngFor="let reminder of group.reminders">
            <ng-template [ngTemplateOutlet]="reminderItem" [ngTemplateOutletContext]="{ reminder }">
            </ng-template>
          </ng-container>
        </ul>
      </li>
    </ul>

    <small class="text-muted" translate>
      Cleared reminders are automatically deleted over time by the retention rules.
    </small>
  </div>

  <footer>
    <div>
      <label class="c8y-switch">
        <input
          [(ngModel)]="toastNotificationsEnabled"
          (change)="setConfig('toast')"
          type="checkbox"
          name="toast-notifications-enabled"
        />
        <span></span>
        {{ 'Toast Notifications' | translate }}
      </label>
    </div>

    <div>
      <label class="c8y-switch">
        <input
          [(ngModel)]="browserNotificationsEnabled"
          (change)="setConfig('browser')"
          type="checkbox"
          name="browser-notifications-enabled"
        />
        <span></span>
        {{ 'Browser Notifications' | translate }}
      </label>
    </div>
  </footer>
</aside>

<!-- single reminder item template -->
<ng-template #reminderItem let-reminder="reminder">
  <li
    class="reminder-item"
    [ngClass]="{
      'text-muted': reminder.status !== reminderStatus.active,
      changed: reminder.changed,
    }"
  >
    <header>
      <i
        class="status-icon"
        [c8yIcon]="
          reminder.status === reminderStatus.active
            ? 'bell'
            : reminder.status === reminderStatus.acknowledged
              ? 'bell-slash'
              : 'check-circle'
        "
        title="Status: {{ reminder.status }}"
      ></i>

      <ng-container *ngIf="reminder.status !== reminderStatus.cleared; else clearedDate">
        <small
          class="date"
          [class.text-danger]="reminder.status === reminderStatus.active && reminder.diff > 0"
          title="{{ 'Due' | translate }}: {{ reminder.time | c8yDate }}"
        >
          {{ reminder.time | amTimeAgo }}
        </small>
      </ng-container>
      <ng-template #clearedDate>
        <small class="date">
          <span title="{{ 'Due' | translate }}: {{ reminder.lastUpdated | c8yDate }}">
            {{ reminder.time | amTimeAgo }}
          </span>
          <span title="{{ 'Last Updated' | translate }}: {{ reminder.lastUpdated | c8yDate }}">
            {{ reminder.lastUpdated | amTimeAgo }}
          </span>
        </small>
      </ng-template>

      <ul class="actions">
        <button
          class="btn btn-xs btn-hollow btn-success"
          *ngIf="reminder.status === reminderStatus.active"
          (click)="updateReminder(reminder, reminderStatus.acknowledged)"
          type="button"
          title="{{ 'Acknowledge the reminder' | translate }}"
        >
          <i [c8yIcon]="'bell-slash'"></i>
        </button>
        <button
          class="btn btn-xs btn-hollow btn-danger"
          *ngIf="reminder.status !== reminderStatus.cleared"
          (click)="updateReminder(reminder, reminderStatus.cleared)"
          type="button"
          title="{{ 'Clear the reminder' | translate }}"
        >
          <i [c8yIcon]="'check-circle'"></i>
        </button>
        <button
          class="btn btn-xs btn-hollow btn-primary"
          *ngIf="reminder.status === reminderStatus.cleared"
          (click)="updateReminder(reminder, reminderStatus.active)"
          type="button"
          title="{{ 'Reactivate the reminder' | translate }}"
        >
          <i [c8yIcon]="'bell'"></i>
        </button>
      </ul>
    </header>

    <p>
      {{ reminder.text }}
    </p>

    <footer>
      <!-- type -->
      <button
        class="btn btn-clean"
        *ngIf="types.length && reminder.reminderType"
        (click)="setFilter(reminder.reminderType)"
        type="button"
      >
        <i class="m-r-4" [c8yIcon]="'tag'"></i>
        <c8y-reminder-type [id]="reminder.reminderType"></c8y-reminder-type>
      </button>
      <!-- asset reference -->
      <ng-container *ngIf="reminder.isGroup; else isDevice">
        <a [routerLink]="['/group', reminder.source.id]">
          <i [c8yIcon]="'c8y-group-open'"></i>
          {{ reminder.source.name }}
        </a>
      </ng-container>
      <ng-template #isDevice>
        <a [routerLink]="['/device', reminder.source.id]">
          <!-- arrows-dotted-left-right -->
          <i [c8yIcon]="'c8y-device'"></i>
          {{ reminder.source.name }}
        </a>
      </ng-template>
    </footer>
  </li>
</ng-template>
